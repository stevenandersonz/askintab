t=`event: delta_encoding
data: "v1"

event: delta
data: {"p": "", "o": "add", "v": {"message": {"id": "011073a6-8057-4f6a-bb95-2f664bced7c8", "author": {"role": "assistant", "name": null, "metadata": {}}, "create_time": 1741288944.172827, "update_time": null, "content": {"content_type": "text", "parts": [""]}, "status": "in_progress", "end_turn": null, "weight": 1.0, "metadata": {"citations": [], "content_references": [], "message_type": "next", "model_slug": "gpt-4o", "default_model_slug": "gpt-4o", "parent_id": "45c127ad-d040-415a-a135-3adfdb29d73a", "model_switcher_deny": []}, "recipient": "all", "channel": null}, "conversation_id": "67c9ad29-a9b0-800d-861a-3bc3ca283e62", "error": null}, "c": 0}     

event: delta
data: {"p": "/message/content/parts/0", "o": "append", "v": "This"}   

event: delta
data: {"v": " statement presents"}    

event: delta
data: {"v": " a"}     

event: delta
data: {"v": " **critique"}    

event: delta
data: {"v": " of intellectual"}       

event: delta
data: {"v": " property ("}    

event: delta
data: {"v": "IP)"}    

event: delta
data: {"v": " laws"}  

event: delta
data: {"v": "** and"} 

event: delta
data: {"v": " the idea that piracy"}  

event: delta
data: {"v": " equates to"}    

event: delta
data: {"v": " theft. The argument"}   

event: delta
data: {"v": " hinges on"}     

event: delta
data: {"v": " a key distinction:\n\n"}

event: delta
data: {"v": "1. **Physical vs"}       

event: delta
data: {"v": ". Digital"}      

event: delta
data: {"v": " Goods**  \n   -"}       

event: delta
data: {"v": " Theft of physical"}     

event: delta
data: {"v": " goods deprives"}

event: delta
data: {"v": " the owner"}     

event: delta
data: {"v": " of their"}      

event: delta
data: {"v": " possession.  \n"}       

event: delta
data: {"v": "   - Pir"}       

event: delta
data: {"v": "acy (unauthorized copying"}      

event: delta
data: {"v": ") does not remove"}      

event: delta
data: {"v": " the original but"}      

event: delta
data: {"v": " creates duplicates.\n\n"}       

event: delta
data: {"v": "2. **Scar"}      

event: delta
data: {"v": "city vs."}       

event: delta
data: {"v": " Infinite Repro"}

event: delta
data: {"v": "ducibility**"}   

event: delta
data: {"v": "  \n   - Physical goods are"}    

event: delta
data: {"v": " scarce; stealing one"}  

event: delta
data: {"v": " means someone else"}    

event: delta
data: {"v": " cannot have"}   

event: delta
data: {"v": " it.  \n"}       

event: delta
data: {"v": "   - Digital"}   

event: delta
data: {"v": " goods (software"}       

event: delta
data: {"v": ", music,"}       

event: delta
data: {"v": " books, etc"}    

event: delta
data: {"v": ".) can be copied"}       

event: delta
data: {"v": " endlessly at near"}     

event: delta
data: {"v": "-zero cost.\n\n"}

event: delta
data: {"v": "### **Is Intellectual"}  

event: delta
data: {"v": " Property a \"D"}

event: delta
data: {"v": "umb Idea\"?**\n- **For"} 

event: delta
data: {"v": "** IP:"} 

event: delta
data: {"v": " It incentivizes"}       

event: delta
data: {"v": " creators by granting them temporary monopol"}   

event: delta
data: {"v": "ies on their"}   

event: delta
data: {"v": " work.\n- **Against"}    

event: delta
data: {"v": "** IP: Some argue"}      

event: delta
data: {"v": " that strict enforcement"}       

event: delta
data: {"v": " restricts knowledge"}   

event: delta
data: {"v": ", creativity,"}  

event: delta
data: {"v": " and technological progress.\n\n"}       

event: delta
data: {"v": "### **On Joe Biden\u2019s"}      

event: delta
data: {"v": " Statement**\n- His analogy equating"}   

event: delta
data: {"v": " piracy to"}     

event: delta
data: {"v": " smashing a"}    

event: delta
data: {"v": " store and"}     

event: delta
data: {"v": " stealing goods"}

event: delta
data: {"v": " is **"} 

: ping - 2025-03-06 19:22:41.128196+00:00

event: delta
data: {"v": "flawed**"}       

event: delta
data: {"v": " because piracy does not remove the original.\n- A"}     

event: delta
data: {"v": " better analogy might"}  

event: delta
data: {"v": " be **\"una"}    

event: delta
data: {"v": "uthorized"}      

event: delta
data: {"v": " replication\"**"}       

event: delta
data: {"v": " rather than theft"}     

event: delta
data: {"v": ".\n- However, piracy can still **cause financial harm"}  

event: delta
data: {"v": "** by reducing potential"}       

event: delta
data: {"v": " sales.\n\n### **"}      

event: delta
data: {"v": "Conclusion**\n- IP laws"}

event: delta
data: {"v": " **have value** in protecting"}  

event: delta
data: {"v": " creators but can be"}   

event: delta
data: {"v": " **overly"}      

event: delta
data: {"v": " restrictive** in the digital"}  

event: delta
data: {"v": " age.\n-"}       

event: delta
data: {"v": " Comparing piracy to"}   

event: delta
data: {"v": " theft **"}      

event: delta
data: {"v": "oversimpl"}      

event: delta
data: {"v": "ifies the"}      

event: delta
data: {"v": " issue**"}       

event: delta
data: {"v": "\u2014it"}       

event: delta
data: {"v": "\u2019s more complex"}   

event: delta
data: {"v": " than a \""}     

event: delta
data: {"v": "smash"}  

event: delta
data: {"v": " and grab"}      

event: delta
data: {"v": ".\"\n-"} 

event: delta
data: {"v": " The real debate"}       

event: delta
data: {"v": " is **how"}      

event: delta
data: {"v": " to balance** the"}      

event: delta
data: {"v": " interests of creators, consumers"}      

event: delta
data: {"p": "", "o": "patch", "v": [{"p": "/message/content/parts/0", "o": "append", "v": ", and society."}, {"p": "/message/status", "o": "replace", "v": "finished_successfully"}, {"p": "/message/end_turn", "o": "replace", "v": true}, {"p": "/message/metadata", "o": "append", "v": {"finish_details": {"type": "stop", "stop_tokens": [200002]}, "is_complete": true}}]}      

data: {"type": "message_stream_complete", "conversation_id": "67c9ad29-a9b0-800d-861a-3bc3ca283e62"}

data: {"type": "conversation_detail_metadata", "banner_info": null, "blocked_features": [], "model_limits": [], "limits_progress": [{"feature_name": "deep_research", "remaining": 10, "reset_after": "2025-04-05T19:22:51.567271+00:00"}], "default_model_slug": "gpt-4o", "conversation_id": "67c9ad29-a9b0-800d-861a-3bc3ca283e62"}

data: [DONE]`

// console.log(JSON.parse('{"v": ".\\"\\n-"}'))
// return
// const t2 = `event: delta
// data: {"v": " interests of creator\ns, consumers"}`

// console.log(t2.replaceAll("\n", "\\n"))
// console.log(t2.replaceAll("\n", "\\n").split("\n"))

// return
// const t1 = '{"v": " a key distinction:\n\n"}';
// console.log(JSON.parse(t1.replaceAll("\n", "\\n")))
// return

function splitByNewlineOutsideQuotes(input) {
  const result = [];
  let current = "";
  let inQuotes = false;
  
  for (let i = 0; i < input.length; i++) {
    const char = input[i];
    
    if (char === '"' && (i === 0 || input[i - 1] !== '\\')) {
      inQuotes = !inQuotes;
    }
    
    if (char === "\n" && !inQuotes) {
      result.push(current);
      current = "";
    } else {
      current += char;
    }
  }
  if (current) result.push(current);
  return result;
}

const formattedText = splitByNewlineOutsideQuotes(t)
//formattedText.forEach(e => console.log(e))
function escapeJsonStrings(json) {
  return json.replace(/"(?:\\.|[^"\\])*"/g, (match) => {
    // Remove surrounding quotes
    const inner = match.slice(1, -1);
    // Replace actual newline characters and unescaped double quotes
    const escapedInner = inner
      .replace(/\n/g, '\\n')
      .replace(/(?<!\\)"/g, '\\"');
    return `"${escapedInner}"`;
  });
}
function fixJsonString(jsonStr) {
  let result = '';
  let inString = false;
  for (let i = 0; i < jsonStr.length; i++) {
    const char = jsonStr[i];
    if (char === '"') {
      if (!inString) {
        inString = true;
        result += char;
      } else {
        // If already escaped, leave it
        if (jsonStr[i - 1] === '\\') {
          result += char;
        } else {
          // Peek ahead to decide if this is a closing quote.
          const nextChar = jsonStr[i + 1];
          if (nextChar && ![',', '}', ' ', '\n', '\t'].includes(nextChar)) {
            result += '\\"';
          } else {
            inString = false;
            result += char;
          }
        }
      }
    } else {
      result += char;
    }
  }
  return result;
}

let events = []
let e = {event: null, data: null}
for (let l of formattedText.filter(l => l !== "")){
  if(l.startsWith("event:")){
    e.event = l.split(":")[1].trim()
  }
  if(l.startsWith("data:")){
    let data = l.slice(6)
    console.log(escapeJsonStrings(data))
    if(data === "[DONE]") continue
    e.data = JSON.parse(fixJsonString(escapeJsonStrings(data)))
    events.push(e)    
    e = {event: null, data: null}
  }
}
console.log(events)

return

let messageParts = [""];

function processDelta(delta) {
  const { p: path, o: operation, v: value } = delta;
  if (!path || path === "") {
    if (operation === "patch" && Array.isArray(value)) {
      value.forEach(patch => processDelta(patch));
    }
    if (!operation) messageParts[0] += value
    return;
  }
  if (path === "/message/content/parts/0" && operation === "append") {
    messageParts[0] += value;
  }
}

processedEvents.forEach(event => {
  if (event.event === "delta" && event.data) {
    if (event.data.p || event.data.o) {
      processDelta(event.data);
    } else if (event.data.v) {
      messageParts[0] += event.data.v; // Append including any newlines
    }
  }
});

console.log(messageParts[0]);